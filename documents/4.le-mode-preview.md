## Le mode preview WordPress sur le site Gatsby

## TL;DR

- On expose une page spéciale `/wp-preview/` (no-index, éventuellement protégée par login) qui permet de **prévisualiser en temps réel** n’importe quel contenu WordPress.
- Cette page lit un paramètre `?path=...` (ou un identifiant) et **récupère les données en direct depuis WordPress**, puis rend la page avec les mêmes composants que la version production.
- Pour que la preview reflète bien le contenu le plus récent, on **évite les `staticQuery`** et on s’appuie sur le `pageContext` + props drilling, afin de garder la logique de rendu pilotée par les données au runtime.
- À terme, un bouton “Preview” dans WordPress pourra rediriger directement vers `/wp-preview/?path=...`, pour offrir une expérience instantanée et uniforme sur toutes les pages.

## Principe de la page `/wp-preview/`

- Création d’une route dédiée, par exemple `/wp-preview/`, qui :
  - n’est **pas indexée par les moteurs de recherche** (meta `noindex`, exclusion du sitemap),
  - peut être **protégée par un mécanisme d’authentification** (login simple, protection basique HTTP, etc.).
- Cette page est une **page Gatsby classique**, qui utilise les mêmes layouts et composants que les pages de production.
- Elle lit un paramètre de requête (par exemple `?path=/banque/guide-x` ou `?id=123`) pour savoir **quel contenu WordPress charger**.

## Récupération dynamique des données WordPress

- Au lieu de s’appuyer sur les données figées du build Gatsby, la page `/wp-preview/` :
  - appelle **WordPress en direct** (via l’API REST ou GraphQL exposé par WordPress),
  - récupère les blocs / champs nécessaires pour construire la page cible,
  - passe ces données aux mêmes composants React que ceux utilisés en production.
- Le rendu obtenu est donc **au plus proche de la réalité production**, mais sans attendre un nouveau build complet.

## Pourquoi éviter les `staticQuery` en preview

- Les `staticQuery` de Gatsby sont **résolues au build** et figées dans le bundle.
- Une fois le site déployé, **on ne peut plus changer les résultats de ces requêtes** sans relancer un build.
- Pour un mode preview en temps réel, on préfère :
  - transporter les données via le `pageContext` et les props,
  - ou les charger côté client/serveur au runtime pour cette page spécifique.
- Cette approche garantit que la **preview reflète bien l’état courant de WordPress**, même si le site n’a pas encore été rebuildé.

## Intégration côté WordPress (bouton Preview)

- À la manière de Prismic et d’autres CMS, on peut ajouter dans WordPress un **bouton “Preview”** qui :
  - construit l’URL de preview (`/wp-preview/?path=...` ou `/wp-preview/?id=...`),
  - redirige l’éditeur directement vers cette page sur le site.
- Avantages :
  - prévisualisation **quasi instantanée** après avoir sauvegardé un brouillon,
  - fonctionnement **uniforme pour toutes les pages** (articles de blog, pages marketing, pages construites via le site builder),
  - expérience simple pour les équipes contenu : “Je clique sur Preview, je vois exactement ce qui sortira en prod une fois le build terminé”.

En résumé, ce mode preview découple la **fréquence de build** de Gatsby de la **fréquence de modification du contenu**, tout en gardant un rendu fidèle et une bonne UX pour les éditeurs.
